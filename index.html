<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRI Taper Plan Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f4f9; color: #333; padding: 20px; max-width: 900px; margin: 0 auto; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1, h2 { margin-top: 0; color: #2c3e50; }
        h2 { font-size: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 20px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px; }
        input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .results-box { background: #eef2f7; padding: 15px; border-radius: 6px; border-left: 5px solid #3498db; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; }
        .result-val { font-weight: bold; color: #2c3e50; }
        .highlight { color: #e74c3c; font-weight: bold; }
        
        button { background-color: #3498db; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background 0.2s; font-weight: 600; }
        button:hover { background-color: #2980b9; }
        button:active { background-color: #1f618d; transform: translateY(1px); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 10px; text-align: right; border-bottom: 1px solid #eee; }
        th { text-align: right; background-color: #f8f9fa; color: #666; font-weight: 600; }
        tr:nth-child(even) { background-color: #fcfcfc; }
        tr:hover { background-color: #f1f1f1; }

        .checkbox-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-size: 14px; }
        .sub-text { font-size: 12px; color: #7f8c8d; margin-top: 4px; }
        .error-msg { color: red; font-size: 14px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>1. Biological Parameters (Settings)</h2>
    <div class="grid">
        <div>
            <div class="input-group">
                <label>Emax (%)</label>
                <input type="number" id="emax" value="92" oninput="calculateInstant()">
            </div>
            <div class="input-group">
                <label>ED50 (mg)</label>
                <input type="number" id="ed50" value="7.7" oninput="calculateInstant()">
            </div>
        </div>
        <div>
            <div class="input-group">
                <label>K1 (SERT Clearance)</label>
                <input type="number" id="k1" value="4" oninput="updateR0(); calculateInstant()">
            </div>
            <div class="input-group">
                <label>K2 (Background Clearance)</label>
                <input type="number" id="k2" value="1" oninput="updateR0(); calculateInstant()">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="autoR0" checked onchange="updateR0(); calculateInstant()">
                <label for="autoR0">Auto-set R0 (Baseline C=1)</label>
            </div>
            <input type="hidden" id="r0" value="5">
        </div>
    </div>
</div>

<div class="container">
    <h2>2. Taper Plan Generator</h2>
    <p class="sub-text">Enter a proposed dose reduction to see the biological impact. Then generate a plan that maintains that consistent impact speed.</p>
    
    <div class="grid" style="grid-template-columns: 1fr 1.5fr;">
        <div>
            <div class="input-group">
                <label>Current Dose (mg)</label>
                <input type="number" id="startDose" value="200" step="1">
            </div>
            <div class="input-group">
                <label>Proposed Next Dose (mg)</label>
                <input type="number" id="nextDose" value="150" step="1">
            </div>
            <button onclick="generatePlan()">Calculate & Generate Plan</button>
            <div id="errorBox" class="error-msg"></div>
        </div>

        <div class="results-box" id="previewBox">
            <div class="result-row">
                <span>Start 5-HT Level:</span>
                <span class="result-val" id="dispStartConc">-</span>
            </div>
            <div class="result-row">
                <span>Next 5-HT Level:</span>
                <span class="result-val" id="dispNextConc">-</span>
            </div>
            <hr style="border-top:1px solid #dcdde1; border-bottom:none;">
            <div class="result-row" style="font-size: 1.1em;">
                <span>Absolute Drop:</span>
                <span class="result-val highlight" id="dispAbsDrop">-</span>
            </div>
            <div class="sub-text">This is the arithmetic difference (Start - Next).</div>
        </div>
    </div>

    <div id="tableContainer" style="display:none;">
        <h3>Generated Linear-Biological Taper Plan</h3>
        <table id="taperTable">
            <thead>
                <tr>
                    <th>Step</th>
                    <th>Dose (mg)</th>
                    <th>RO (%)</th>
                    <th>5-HT Level<br>(% of Base)</th>
                    <th>Reduction<br>from Peak (%)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    
    <div style="margin-top: 30px;">
        <canvas id="taperChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<script>
    let myChart = null;

    // --- MATH FUNCTIONS ---

    function getRO(dose) {
        const emax = parseFloat(document.getElementById('emax').value);
        const ed50 = parseFloat(document.getElementById('ed50').value);
        if (dose <= 0) return 0;
        return (emax * dose) / (ed50 + dose);
    }

    function getDoseFromRO(ro) {
        const emax = parseFloat(document.getElementById('emax').value);
        const ed50 = parseFloat(document.getElementById('ed50').value);
        
        if (ro >= emax - 0.0001) return 9999; 
        if (ro <= 0) return 0;
        
        return (ro * ed50) / (emax - ro);
    }

    function getConc(dose) {
        const k1 = parseFloat(document.getElementById('k1').value);
        const k2 = parseFloat(document.getElementById('k2').value);
        const r0 = parseFloat(document.getElementById('r0').value);
        const ro = getRO(dose); 
        
        const theta = ro / 100.0;
        const denom = k1 * (1.0 - theta) + k2;
        if (denom === 0) return 0;
        return r0 / denom;
    }

    function getROFromConc(conc) {
        const k1 = parseFloat(document.getElementById('k1').value);
        const k2 = parseFloat(document.getElementById('k2').value);
        const r0 = parseFloat(document.getElementById('r0').value);
        
        if (conc <= 0) return 0;
        let theta = (conc * (k1 + k2) - r0) / (conc * k1);
        
        if (theta < 0) theta = 0;
        if (theta > 1) theta = 1; 

        return theta * 100.0; 
    }

    function updateR0() {
        const k1 = parseFloat(document.getElementById('k1').value);
        const k2 = parseFloat(document.getElementById('k2').value);
        if (document.getElementById('autoR0').checked) {
            document.getElementById('r0').value = k1 + k2;
        }
    }

    function calculateInstant() {
        // Placeholder
    }

    // --- MAIN GENERATOR LOGIC ---

    function generatePlan() {
        try {
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';

            const startDose = parseFloat(document.getElementById('startDose').value);
            const nextDose = parseFloat(document.getElementById('nextDose').value);
            
            if (isNaN(startDose) || isNaN(nextDose)) {
                throw new Error("Please enter valid numbers for dose.");
            }

            // 1. Calculate the Drop Size
            const startConc = getConc(startDose);
            const nextConc = getConc(nextDose);
            const baselineConc = getConc(0); 

            const dropSize = startConc - nextConc;
            
            if (dropSize <= 0) {
                 throw new Error("Next dose must be lower than current dose to create a taper.");
            }

            // --- CHANGED LOGIC HERE ---
            // Calculate absolute difference instead of percentage
            const absDropDisplay = (startConc * 100) - (nextConc * 100);

            // Update Preview Box
            document.getElementById('dispStartConc').innerText = (startConc * 100).toFixed(1);
            document.getElementById('dispNextConc').innerText = (nextConc * 100).toFixed(1);
            document.getElementById('dispAbsDrop').innerText = absDropDisplay.toFixed(1);
            // --------------------------

            // 2. Generate Table
            const tbody = document.querySelector('#taperTable tbody');
            tbody.innerHTML = '';

            let currentConc = startConc;
            let step = 1;
            let chartLabels = [];
            let chartData = [];
            let safety = 0;
            
            while (currentConc > baselineConc + 0.01 && safety < 1000) {
                let ro = getROFromConc(currentConc);
                const emax = parseFloat(document.getElementById('emax').value);
                if (ro > emax) ro = emax - 0.001;

                let dose = getDoseFromRO(ro);
                let reductionFromPeak = ((startConc - currentConc) / startConc) * 100;
                
                addRow(step, dose, ro, currentConc * 100, reductionFromPeak);
                
                chartLabels.push(step);
                chartData.push(currentConc * 100);

                currentConc -= dropSize;
                step++;
                safety++;
            }

            const totalReduction = ((startConc - baselineConc) / startConc) * 100;
            addRow(step, 0, 0, 100, totalReduction);
            chartLabels.push(step);
            chartData.push(100);

            if (typeof Chart !== 'undefined') {
                updateChart(chartLabels, chartData);
            }

        } catch (err) {
            const errBox = document.getElementById('errorBox');
            errBox.innerText = "Error: " + err.message;
            errBox.style.display = 'block';
            console.error(err);
        }
    }

    function addRow(step, dose, ro, concPct, redPct) {
        const tbody = document.querySelector('#taperTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${step}</td>
            <td>${dose.toFixed(2)}</td>
            <td>${ro.toFixed(1)}</td>
            <td>${concPct.toFixed(1)}</td>
            <td>${redPct.toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
    }

    function updateChart(labels, data) {
        const ctx = document.getElementById('taperChart').getContext('2d');
        if (myChart) { myChart.destroy(); }

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '5-HT Level (% of Baseline)',
                    data: data,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Step Number' } },
                    y: { title: { display: true, text: '5-HT Level (%)' } }
                }
            }
        });
    }

    updateR0();
</script>

</body>
</html>